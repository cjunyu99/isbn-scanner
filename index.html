<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISBN æ›¸ç±ç®¡å®¶ (ç¶²é ç‰ˆ)</title>
    <!-- ä½¿ç”¨ Tailwind CSS é€²è¡Œå¿«é€Ÿæ’ç‰ˆ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ QuaggaJS é€²è¡Œæ¢ç¢¼æƒæ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6;
        }
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* æƒæè¦–çª—æ¨£å¼èª¿æ•´ */
        #interactive.viewport {
            position: relative;
            width: 100%;
            height: 300px;
            overflow: hidden;
            background: #000;
        }
        #interactive.viewport > canvas, #interactive.viewport > video {
            max-width: 100%;
            width: 100%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        /* æƒæç·šå‹•ç•« */
        .scan-line {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: rgba(255, 0, 0, 0.7);
            box-shadow: 0 0 4px red;
            animation: scan 2s infinite linear;
            z-index: 10;
        }
        @keyframes scan {
            0% { top: 10%; }
            50% { top: 90%; }
            100% { top: 10%; }
        }
    </style>
</head>
<body class="p-6">

    <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden">
        <!-- æ¨™é¡Œå€ -->
        <div class="bg-blue-600 p-6 text-white">
            <h1 class="text-2xl font-bold">ğŸ“š ISBN æ›¸ç±è³‡è¨ŠæŸ¥è©¢èˆ‡ç´€éŒ„</h1>
            <p class="text-blue-100 text-sm mt-2">è¼¸å…¥ ISBN æˆ–ä½¿ç”¨é¡é ­æƒææ¢ç¢¼</p>
        </div>

        <!-- æ“ä½œå€ -->
        <div class="p-6 border-b border-gray-200">
            <div class="flex flex-col md:flex-row gap-4 items-end">
                <div class="flex-grow w-full relative">
                    <label for="isbnInput" class="block text-sm font-medium text-gray-700 mb-1">ISBN è™Ÿç¢¼</label>
                    <div class="flex gap-2">
                        <input type="text" id="isbnInput" placeholder="ä¾‹å¦‚: 9789861371955" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                               onkeypress="handleKeyPress(event)">
                        <!-- æƒææŒ‰éˆ• -->
                        <button onclick="startScanner()" class="bg-gray-800 hover:bg-gray-700 text-white px-3 py-2 rounded-lg transition" title="ä½¿ç”¨é¡é ­æƒæ">
                            ğŸ“·
                        </button>
                    </div>
                </div>
                <button onclick="fetchBook()" id="searchBtn"
                        class="w-full md:w-auto px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition flex items-center justify-center gap-2 whitespace-nowrap">
                    <span>ğŸ” æŸ¥è©¢ä¸¦åŠ å…¥</span>
                </button>
            </div>
            <p id="statusMsg" class="text-sm mt-2 h-5 text-red-500"></p>
        </div>

        <!-- å·¥å…·åˆ— -->
        <div class="bg-gray-50 px-6 py-3 flex flex-col md:flex-row justify-between items-center border-b border-gray-200 gap-3">
            <span class="text-gray-600 text-sm">ç›®å‰è—æ›¸ï¼š<span id="bookCount" class="font-bold text-gray-900">0</span> æœ¬</span>
            
            <div class="flex flex-wrap gap-2">
                <input type="file" id="importInput" accept=".txt,.json" class="hidden" onchange="handleFileImport(event)">
                
                <button onclick="clearList()" class="text-sm text-red-600 hover:text-red-800 px-3 py-1.5 rounded hover:bg-red-50 transition border border-transparent hover:border-red-200">
                    ğŸ—‘ï¸ æ¸…ç©º
                </button>
                <button onclick="document.getElementById('importInput').click()" class="text-sm bg-purple-600 hover:bg-purple-700 text-white px-4 py-1.5 rounded shadow transition flex items-center gap-1">
                    ğŸ“‚ åŒ¯å…¥æª”æ¡ˆ
                </button>
                <button onclick="exportToTextFile()" class="text-sm bg-green-600 hover:bg-green-700 text-white px-4 py-1.5 rounded shadow transition flex items-center gap-1">
                    ğŸ’¾ åŒ¯å‡ºå‚™ä»½ (.txt)
                </button>
            </div>
        </div>

        <!-- åˆ—è¡¨å€ -->
        <div class="overflow-x-auto">
            <table class="w-full text-left text-sm text-gray-600">
                <thead class="bg-gray-100 text-gray-700 uppercase font-semibold">
                    <tr>
                        <th class="px-6 py-3">æ›¸å</th>
                        <th class="px-6 py-3">ä½œè€…</th>
                        <th class="px-6 py-3">å‡ºç‰ˆç¤¾</th>
                        <th class="px-6 py-3">ISBN</th>
                        <th class="px-6 py-3 text-center">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="bookListBody" class="divide-y divide-gray-200">
                    <tr>
                        <td colspan="5" class="px-6 py-8 text-center text-gray-400">ç›®å‰æ²’æœ‰è³‡æ–™ï¼Œè«‹è¼¸å…¥ ISBN é€²è¡ŒæŸ¥è©¢</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- æƒæå™¨ Modal -->
    <div id="scannerModal" class="fixed inset-0 z-50 bg-black bg-opacity-95 hidden flex flex-col items-center justify-center p-4">
        <div class="w-full max-w-md bg-white rounded-lg overflow-hidden shadow-2xl">
            <div class="bg-gray-900 text-white p-3 flex justify-between items-center">
                <span class="font-bold">ğŸ“· æƒææ¢ç¢¼</span>
                <button onclick="stopScanner()" class="text-gray-400 hover:text-white">&times;</button>
            </div>
            <div id="interactive" class="viewport bg-black relative">
                <!-- æƒæç·š -->
                <div class="scan-line"></div>
                <p class="absolute bottom-2 w-full text-center text-white text-xs z-10 bg-black bg-opacity-50 py-1">è«‹å°‡ ISBN æ¢ç¢¼ç½®æ–¼é¡é ­ä¸­å¤®</p>
            </div>
            <div class="p-4 bg-gray-100 text-center">
                <button onclick="stopScanner()" class="w-full py-2 bg-red-600 text-white rounded font-bold">é—œé–‰é¡é ­</button>
            </div>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–è³‡æ–™
        let books = JSON.parse(localStorage.getItem('myLibrary')) || [];
        
        document.addEventListener('DOMContentLoaded', () => {
            renderTable();
        });

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                fetchBook();
            }
        }

        // ==========================================
        //  ç›¸æ©ŸæƒæåŠŸèƒ½ (QuaggaJS)
        // ==========================================
        let isScanning = false;

        function startScanner() {
            // æª¢æŸ¥ç€è¦½å™¨æ”¯æ´
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´ç›¸æ©ŸåŠŸèƒ½ï¼Œæˆ–ç¶²ç«™æœªåœ¨ HTTPS å®‰å…¨ç’°å¢ƒä¸‹åŸ·è¡Œã€‚");
                return;
            }

            const modal = document.getElementById('scannerModal');
            modal.classList.remove('hidden');

            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#interactive'),
                    constraints: {
                        facingMode: "environment", // å„ªå…ˆä½¿ç”¨å¾Œç½®é¡é ­
                        width: { min: 640 },
                        height: { min: 480 },
                        aspectRatio: { min: 1, max: 2 }
                    }
                },
                locator: {
                    patchSize: "medium",
                    halfSample: true
                },
                numOfWorkers: 2,
                decoder: {
                    readers: ["ean_reader"] // åªæƒæ EAN (ISBN æ˜¯ EAN-13)
                },
                locate: true
            }, function(err) {
                if (err) {
                    console.log(err);
                    alert("ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿ: " + err);
                    modal.classList.add('hidden');
                    return;
                }
                console.log("Initialization finished. Ready to start");
                Quagga.start();
                isScanning = true;
            });

            // åµæ¸¬åˆ°æ¢ç¢¼æ™‚çš„è™•ç†
            Quagga.onDetected(function(result) {
                const code = result.codeResult.code;
                
                // ç°¡å–®é©—è­‰ï¼šISBN é€šå¸¸ä»¥ 978 æˆ– 979 é–‹é ­
                if (code && (code.startsWith("978") || code.startsWith("979"))) {
                    // æª¢æŸ¥æ ¡é©—ç¢¼æˆ–å¤šæ¬¡ç¢ºèªå¯ä»¥å¢åŠ æº–ç¢ºåº¦ï¼Œé€™è£¡ç›´æ¥æ¡ç”¨
                    
                    // æ’­æ”¾æç¤ºéŸ³ (é¸ç”¨)
                    // const audio = new Audio('beep.mp3'); audio.play().catch(e=>{});

                    document.getElementById('isbnInput').value = code;
                    stopScanner();
                    
                    // ç¨å¾®å»¶é²ä¸€ä¸‹è®“ä½¿ç”¨è€…çœ‹åˆ°è™Ÿç¢¼å¡«å…¥
                    setTimeout(() => {
                        fetchBook();
                    }, 300);
                }
            });
        }

        function stopScanner() {
            if (isScanning) {
                Quagga.stop();
                isScanning = false;
            }
            document.getElementById('scannerModal').classList.add('hidden');
        }

        // ==========================================
        //  åŸæœ‰åŠŸèƒ½ï¼šæŸ¥è©¢ã€åˆ—è¡¨ã€åŒ¯å‡ºå…¥
        // ==========================================

        async function fetchBook() {
            const input = document.getElementById('isbnInput');
            const status = document.getElementById('statusMsg');
            const btn = document.getElementById('searchBtn');
            
            const isbn = input.value.replace(/[-\s]/g, '');

            if (!isbn) {
                status.textContent = 'âŒ è«‹è¼¸å…¥ ISBN è™Ÿç¢¼';
                return;
            }

            if (books.some(book => book.isbn === isbn)) {
                status.textContent = 'âš ï¸ é€™æœ¬æ›¸å·²ç¶“åœ¨æ¸…å–®ä¸­äº†';
                return;
            }

            status.textContent = '';
            btn.innerHTML = '<div class="loader"></div> æŸ¥è©¢ä¸­...';
            btn.disabled = true;

            try {
                const response = await fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}`);
                const data = await response.json();

                if (data.totalItems > 0) {
                    const info = data.items[0].volumeInfo;
                    
                    const newBook = {
                        id: Date.now(),
                        isbn: isbn,
                        title: info.title || "æœªçŸ¥æ›¸å",
                        authors: info.authors ? info.authors.join(', ') : "æœªçŸ¥ä½œè€…",
                        publisher: info.publisher || "æœªçŸ¥å‡ºç‰ˆç¤¾",
                        publishedDate: info.publishedDate || "æœªçŸ¥æ—¥æœŸ",
                        addedAt: new Date().toLocaleString()
                    };

                    books.unshift(newBook);
                    saveAndRender();
                    input.value = '';
                    status.textContent = `âœ… æˆåŠŸåŠ å…¥ï¼š${newBook.title}`;
                    status.className = "text-sm mt-2 h-5 text-green-600";
                } else {
                    status.textContent = 'âŒ æ‰¾ä¸åˆ°æ­¤ ISBN çš„æ›¸ç±è³‡æ–™';
                    status.className = "text-sm mt-2 h-5 text-red-500";
                }
            } catch (error) {
                console.error(error);
                status.textContent = 'âŒ é€£ç·šéŒ¯èª¤æˆ–æ‰¾ä¸åˆ°è³‡æ–™';
                status.className = "text-sm mt-2 h-5 text-red-500";
            } finally {
                btn.innerHTML = '<span>ğŸ” æŸ¥è©¢ä¸¦åŠ å…¥</span>';
                btn.disabled = false;
            }
        }

        function renderTable() {
            const tbody = document.getElementById('bookListBody');
            const countSpan = document.getElementById('bookCount');
            
            countSpan.textContent = books.length;

            if (books.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="px-6 py-8 text-center text-gray-400">ç›®å‰æ²’æœ‰è³‡æ–™ï¼Œè«‹è¼¸å…¥ ISBN é€²è¡ŒæŸ¥è©¢</td></tr>`;
                return;
            }

            tbody.innerHTML = books.map(book => `
                <tr class="hover:bg-gray-50 transition">
                    <td class="px-6 py-4 font-medium text-gray-900">${book.title}</td>
                    <td class="px-6 py-4">${book.authors}</td>
                    <td class="px-6 py-4">${book.publisher}</td>
                    <td class="px-6 py-4 font-mono text-xs bg-gray-50 rounded">${book.isbn}</td>
                    <td class="px-6 py-4 text-center">
                        <button onclick="removeBook(${book.id})" class="text-red-500 hover:text-red-700 font-bold text-lg" title="åˆªé™¤">
                            &times;
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function removeBook(id) {
            if(confirm('ç¢ºå®šè¦åˆªé™¤é€™æœ¬æ›¸å—ï¼Ÿ')) {
                books = books.filter(book => book.id !== id);
                saveAndRender();
            }
        }

        function clearList() {
            if (books.length === 0) return;
            if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚')) {
                books = [];
                saveAndRender();
                document.getElementById('statusMsg').textContent = '';
            }
        }

        function saveAndRender() {
            localStorage.setItem('myLibrary', JSON.stringify(books));
            renderTable();
        }

        function exportToTextFile() {
            if (books.length === 0) {
                alert("ç›®å‰æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡ºï¼");
                return;
            }

            let content = "æˆ‘çš„æ›¸ç±æ¸…å–®\n";
            content += "========================================\n";
            content += `åŒ¯å‡ºæ™‚é–“: ${new Date().toLocaleString()}\n`;
            content += `ç¸½æ•¸é‡: ${books.length} æœ¬\n`;
            content += "========================================\n\n";

            books.forEach((book, index) => {
                content += `[${index + 1}] æ›¸å: ${book.title}\n`;
                content += `    ä½œè€…: ${book.authors}\n`;
                content += `    å‡ºç‰ˆç¤¾: ${book.publisher}\n`;
                content += `    ISBN: ${book.isbn}\n`;
                content += `    å‡ºç‰ˆæ—¥: ${book.publishedDate}\n`;
                content += "----------------------------------------\n";
            });

            content += "\n\n";
            content += "===== RAW DATA (DO NOT EDIT BELOW) =====\n";
            content += JSON.stringify(books);
            
            const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `library_export_${new Date().toISOString().slice(0,10)}.txt`;
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                let importedBooks = [];
                let importCount = 0;
                let skipCount = 0;

                const jsonMarker = "===== RAW DATA (DO NOT EDIT BELOW) =====";
                const jsonIndex = content.indexOf(jsonMarker);

                if (jsonIndex !== -1) {
                    try {
                        const jsonString = content.substring(jsonIndex + jsonMarker.length).trim();
                        importedBooks = JSON.parse(jsonString);
                        console.log("ä½¿ç”¨ JSON æ¨¡å¼åŒ¯å…¥");
                    } catch (err) {
                        console.error("JSON è§£æå¤±æ•—ï¼Œå˜—è©¦æ–‡å­—è§£æ", err);
                    }
                }
                
                if (importedBooks.length === 0) {
                    console.log("ä½¿ç”¨æ–‡å­—è§£ææ¨¡å¼åŒ¯å…¥");
                    const blocks = content.split('----------------------------------------');
                    
                    blocks.forEach(block => {
                        const titleMatch = block.match(/æ›¸å: (.*)/);
                        const authorMatch = block.match(/ä½œè€…: (.*)/);
                        const publisherMatch = block.match(/å‡ºç‰ˆç¤¾: (.*)/);
                        const isbnMatch = block.match(/ISBN: (.*)/);
                        const dateMatch = block.match(/å‡ºç‰ˆæ—¥: (.*)/);

                        if (isbnMatch && titleMatch) {
                            importedBooks.push({
                                id: Date.now() + Math.random(),
                                title: titleMatch[1].trim(),
                                authors: authorMatch ? authorMatch[1].trim() : "æœªçŸ¥",
                                publisher: publisherMatch ? publisherMatch[1].trim() : "æœªçŸ¥",
                                isbn: isbnMatch[1].trim(),
                                publishedDate: dateMatch ? dateMatch[1].trim() : "æœªçŸ¥",
                                addedAt: new Date().toLocaleString()
                            });
                        }
                    });
                }

                if (importedBooks.length === 0) {
                    alert("âŒ ç„¡æ³•è¾¨è­˜æª”æ¡ˆå…§å®¹ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ˜¯å¦æ­£ç¢ºã€‚");
                    return;
                }

                importedBooks.forEach(newBook => {
                    const exists = books.some(b => b.isbn === newBook.isbn);
                    if (!exists) {
                        if (!newBook.id) newBook.id = Date.now() + Math.random();
                        if (!newBook.addedAt) newBook.addedAt = new Date().toLocaleString();
                        
                        books.unshift(newBook);
                        importCount++;
                    } else {
                        skipCount++;
                    }
                });

                saveAndRender();
                alert(`åŒ¯å…¥å®Œæˆï¼\nâœ… æˆåŠŸåŒ¯å…¥: ${importCount} æœ¬\nâš ï¸ é‡è¤‡è·³é: ${skipCount} æœ¬`);
                event.target.value = '';
            };
            
            reader.readAsText(file);
        }
    </script>
</body>
</html>